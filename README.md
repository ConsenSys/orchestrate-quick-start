# PegaSys Orchestrate Quickstart

PegaSys Orchestrate Quickstart

During this quickstart you will:

1. Start PegaSys Orchestrate locally using `docker-compose`
2. Manipulate PegaSys Orchestrate CLI (Account generator and contract registry)
3. Manipulate Orchestrate SDK (Send a batch of transactions)
4. Inspect Ethereum Accounts stored in Hashicorp Vault

## Requirements

- Have [`docker`](https://www.docker.com/) and [`docker-compose`](https://docs.docker.com/compose/install/) installed
- Have [`node` and `npm`](https://nodejs.org/en/) installed

## Setup for Orchestrate

####<a name="config-env"></a> Configure the ENV variables

Create a `.env` file base on the file `.env.example`

1 Set the variables to pull the Orchestrate image

> _Note_: If running Orchestrate for the 1st you will first need to login on Orchestrate Docker registry, base on the information provide by the Orchestrate team

```
docker login -u <username> -p <password> consensys-docker-pegasys-orchestrate.bintray.io
```

```.env
# Docker image and version
DOCKER_REGISTRY=<DOCKER_REGISTRY>
ORCHESTRATE_VERSION=<ORCHESTRATE_VERSION>
```

2 Set Ethereum client endpoints

For the quickstart we will connect to Rinkeby through Infura

- Replace the <INFURA_KEY> placeholders with your Infura key below
- Add the block number <BlockNumber> from which to read

```.env
CHAIN_REGISTRY_INIT={"name":"rinkeby","urls":["https://rinkeby.infura.io/v3/<INFURA_KEY>"], "listener": {"blockPosition": "<BlockNumber>"} }
```

##<a name="start"></a> Start Orchestrate

1. Start Orchestrate

```
make up
```

This will:

- start the dependencies (Kafka, Redis, Postgres, etc.). See `scripts/deps/docker-compose.yml`)
- Create the Kafka topics with default names (see `scripts/kafka/initTopics.sh`)
- Start Orchestrate Microservices

## Manipulate PegaSys Orchestrate CLI

### List of commands of PegaSys Orchestrate CLI

List of commands for PegaSys Orchestrate CLI

```bash
yarn orchestrate help
```

details arguments for each commands of PegaSys Orchestrate CLI

```bash
yarn orchestrate help [cmd]
```

> _Sample_: Command to details the arguments of smart-contract management by Orchestrate `yarn orchestrate help contracts`

details options for each arguments of PegaSys Orchestrate CLI

```bash
yarn orchestrate [cmd] [arg] --help
```

> _Sample_: Command to details the options of register a smart-contract with Orchestrate `yarn orchestrate contracts register --help`

### Preset commands

> _Note_: Specifically for the Quick-Start, some preset commands are define to easier use Orchestrate CLI without complex options

####<a name="generate-account"></a> Account generator

1 Generate wallet

```bash
yarn generate-account
```

> _Warning_: Currently, the prefunding of account is not available on Orchestrate, you have to fund the account generated by yourself (ex: MetaMask)

> _Orchestrate Team is working in priority to resolve this issues._

2 Specify here the Ethereum account generated

```.env
ETH_ACCOUNT=<ETHEREUM_ACCOUNT_ADDRESS>
```

#### Smart-contract management

1 List all smart-contracts register into the contracts-registry of Orchestrate

```bash
yarn get-catalog
```

2 Compile contract using Truffle

```bash
yarn truffle compile
```

Logs:

```bash
Compiling your contracts...
===========================
> Compiling ./smart-contracts/Counter.sol
> Artifacts written to /Users/arnaud/Projects/core-stack/quick-start/build/contracts
> Compiled successfully using:
   - solc: 0.5.16+commit.9c3226ce.Emscripten.clang
```

3 Register smart-contract artifacts with just compile

```bash
yarn register-smart-contract
```

Logs:

```bash
Contract successfully registered
```

4 List the smart-contract we have just registered

```bash
yarn get-catalog
```

Logs:

```bash
[ 'Counter' ]
```

4 Get details of the smart-contract we have just registered

```bash
yarn details-smart-contract
```

Logs:

```json
{
  "name": "Counter",
  "tag": "v0.1.0",
  "abi": [
    {
      "anonymous": false,
      "inputs": [Array],
      "name": "Incremented",
      "type": "event"
    },
    {
      "constant": false,
      "inputs": [Array],
      "name": "increment",
      "outputs": [],
      "payable": false,
      "stateMutability": "nonpayable",
      "type": "function"
    }
  ],
  "bytecode": "0x6080604052348015600f57600080fd5b5061010a8061001f6000396000f3fe6080604052348015600f57600080fd5b506004361060285760003560e01c80637cf5dab014602d575b600080fd5b605660048036036020811015604157600080fd5b81019080803590602001909291905050506058565b005b8060008082825401925050819055507f38ac789ed44572701765277c4d0970f2db1c1a571ed39e84358095ae4eaa54203382604051808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018281526020019250505060405180910390a15056fea265627a7a7231582054180fac75141bd437bb1367be73511a6ba9f049644329b8ae4a9286f73dc12564736f6c63430005100032",
  "deployedBytecode": "0x6080604052348015600f57600080fd5b506004361060285760003560e01c80637cf5dab014602d575b600080fd5b605660048036036020811015604157600080fd5b81019080803590602001909291905050506058565b005b8060008082825401925050819055507f38ac789ed44572701765277c4d0970f2db1c1a571ed39e84358095ae4eaa54203382604051808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018281526020019250505060405180910390a15056fea265627a7a7231582054180fac75141bd437bb1367be73511a6ba9f049644329b8ae4a9286f73dc12564736f6c63430005100032"
}
```

## Inspect Accounts stored in Hashicorp Vault

1. You can inspect Ethereum accounts that have been stored in Hashicorp Vault by running

```bash
make hashicorp-accounts
```

That will return list of addresses

```bash
Keys
----
0x05a34cE77Ea9fc49E4E5C7c4bC0E9aB2447AB6f0
0x67689FDDecD92938932B21D566D089cc45A62769
0x7E654d251Da770A068413677967F6d3Ea2FeA9E4
```

2. You can run any hashicorp Vault CLI command (c.f. https://www.vaultproject.io/docs/commands/) by running

```bash
make hashicorp-vault COMMAND="<command>"
```

For example

```bash
make hashicorp-vault COMMAND="token lookup"
Key                 Value
---                 -----
accessor            ZxDozUcdrwEFENpialO3AvWi
creation_time       1578672722
creation_ttl        0s
display_name        root
entity_id           n/a
expire_time         <nil>
explicit_max_ttl    0s
id                  s.LjlIldnulzUvUgZpVnrPy6Qb
meta                <nil>
num_uses            0
orphan              true
path                auth/token/root
policies            [root]
ttl                 0s
type                service
```

## Manipulate SDK

#### Requirements

You have to:

- [Configure the ENV variables](#config-env)
- [Start Orchestrate](#start)
- [Generate an Account](#generate-account)

#### Using SDK

1. Deploy contracts on Ropsten and Rinkeby

Have a look to script `src/deploy-contract/deploy.js`:

- Set `chainName` with `rinkeby` or other `chainName` who was register in the chain-registry.

Then you can run script by entering command

```bash
yarn deploy
```

2. Send a batch of transaction

In the `.env` file:

- Set `COUNTER_CONTRACT_ADDRESS` env variable

Have a look to the script `src/send-tx/send-tx.js`:

- Set `chainName` with `rinkeby` or other `name` who was register in the env variable `CHAIN_REGISTRY_INIT`.

Then you can run it by entering command

```bash
yarn send-tx
```
