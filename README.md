# PegaSys Orchestrate Quickstart

PegaSys Orchestrate Quickstart

During this quickstart you will:

1. Start PegaSys Orchestrate locally using `docker-compose`
2. Manipulate PegaSys Orchestrate CLI (Account generator and contract registry)
3. Manipulate Orchestrate SDK (Send a batch of transactions)
4. Inspect Ethereum Accounts stored in Hashicorp Vault

## Requirements

- Have [`docker`](https://www.docker.com/) and [`docker-compose`](https://docs.docker.com/compose/install/) installed
- Have [`node` and `npm`](https://nodejs.org/en/) installed

## Setup for Orchestrate

### Configure the ENV variables

Create a `.env` file based on the file `.env.example`

#### 1) Set the variables to pull the Orchestrate image

> _Note_: If running Orchestrate for the 1st you will first need to login on Orchestrate Docker registry, base on the information provide by the Orchestrate team

```
docker login -u <username> -p <password> consensys-docker-pegasys-orchestrate.bintray.io
```

```.env
# Docker image and version
DOCKER_REGISTRY=<DOCKER_REGISTRY>
ORCHESTRATE_VERSION=<ORCHESTRATE_VERSION>
```

#### 2) Set Ethereum client endpoints

For the quickstart we will connect to Rinkeby through Infura

- Replace the <INFURA_KEY> placeholders with your Infura key below
- Add the block number <START_BLOCK_NUMBER> from which to start reading

```.env
CHAIN_DATA={"name":"rinkeby","urls":["https://rinkeby.infura.io/v3/<INFURA_KEY>"],"listener":{"blockPosition":"<START_BLOCK_NUMBER>"}}
```

## Start Orchestrate

Run the following command:

```
make up
```

This will:

- start the dependencies (Kafka, Redis, Postgres, etc.). See `scripts/deps/docker-compose.yml`)
- Create the Kafka topics with default names (see `scripts/kafka/initTopics.sh`)
- Start Orchestrate Microservices

## Manipulate the PegaSys Orchestrate CLI

Run the following command:

```bash
npm install
```

### List of commands of PegaSys Orchestrate CLI

Run the following command:

```bash
npm run orchestrate help
```

To access details of each command:

```bash
npm run orchestrate [cmd] help
```

> Example: `npm run orchestrate contracts help`

You can also recursively call `--help` on each argument of a command.

```bash
npm run orchestrate [cmd] [arg] --help
```

> To ease the use of this Quick start, some shortcut commands have been defined and can be seen in the `package.json` file.

### Registering a new chain in the Chain Registry

To add a new chain to the chain registry and start listening to transactions coming from that chain, run the following command:

```bash
npm run register-chain
```

by doing that, we connect Orchestrate to the Rinkeby tesnet though Infura.

> Have a look at the script `src/register-chain/register.ts` for reference

### Account generator

Run the following command:

```bash
npm run generate-account
```

> _Warning_: Currently, the prefunding of account is not available on Orchestrate, you have to fund the account generated by yourself (ex: MetaMask)

> _Orchestrate Team is working in priority to resolve these issues._

And specify the account generated in the `.env`

```.env
ETH_ACCOUNT=<ETHEREUM_ACCOUNT_ADDRESS>
```

### Smart Contract management

Use Truffle (already installed) to compile your smart contracts into the `build` folder:

```bash
npm run compile
```

Register the generated artifacts into Orchestrate:

```bash
npm run register-contract
```

Verify that the contract has been successfully registered:

```bash
npm run get-catalog
```

You can also get the full details of the registered contract:

```bash
npm run get-contract
```

## Manipulate the SDK

### Consuming transaction messages

PegaSys is a transaction orchestrator. Transactions on Ethereum being asynchronous, you will receive the result of a transaction by consuming messages coming from Orchestrate.

To do so, open two tabs on your terminal. In one tab we will consume messages and check the transaction receipt. On the other, we will send transactions. On the first tab, run:

```bash
npm run consume
```

### Deploying a contract

We will deploy a contract on the Rinkeby testnet. On the second tab, run:

> Have a look at the script `src/deploy-contract/deploy.ts` for reference

```bash
npm run deploy
```

Verify in the first tab that you received the message successfully and copy-paste the value of the `contractAddress` in the `.env` file:

```.env
COUNTER_CONTRACT_ADDRESS=<COUNTER_CONTRACT_ADDRESS>
```

### Sending a batch of transactions

We will now send a batch of transactions to the `Counter` contract we just deployed to increment the counter by 1 in each transaction. The SDK ensures that the transactions are sent in order.

> Have a look at the script `src/send-tx/send-tx.ts` for reference

```bash
npm run send-tx
```

Check the receipt in the first tab to verify that all transactions have been received successfully.

## Inspect Accounts stored in Hashicorp Vault

1. You can inspect Ethereum accounts that have been stored in Hashicorp Vault by running

```bash
make hashicorp-accounts
```

That will return list of addresses

```bash
Keys
----
0x05a34cE77Ea9fc49E4E5C7c4bC0E9aB2447AB6f0
0x67689FDDecD92938932B21D566D089cc45A62769
0x7E654d251Da770A068413677967F6d3Ea2FeA9E4
```

2. You can run any hashicorp Vault CLI command (c.f. https://www.vaultproject.io/docs/commands/) by running

```bash
make hashicorp-vault COMMAND="<command>"
```

For example

```bash
make hashicorp-vault COMMAND="token lookup"
Key                 Value
---                 -----
accessor            ZxDozUcdrwEFENpialO3AvWi
creation_time       1578672722
creation_ttl        0s
display_name        root
entity_id           n/a
expire_time         <nil>
explicit_max_ttl    0s
id                  s.LjlIldnulzUvUgZpVnrPy6Qb
meta                <nil>
num_uses            0
orphan              true
path                auth/token/root
policies            [root]
ttl                 0s
type                service
```
